## 자바 직렬화의 대안을 찾으라

### 객체 직렬화
자바가 객체를 바이트 스트림으로 인코딩하고(직렬화), 그 바이트 스트림으로부터 다시 객체를 재구성하는(역직렬화) 매커니즘이다.  
직렬화된 객체는 다른 VM에 전송하거나 디스크에 저장할 수 있다.  

</br>

### 직렬화 문제
1997년 처음으로 자바에 직렬화가 도입  
연구용 언어인 모둘라-3에서나 시도되었을 뿐, 대중적 언어에 사용된 것은 처음  
보이지 않는 생성자, API와 구현 사이의 모호해진 경계, 잠재적인 정확성 문제, 성능, 보안 등 이슈 존재  
직렬화의 근본적인 문제는 공격 범위가 넓고 방어하기 어렵다는 점  
ObjectInputStream.readObjet() 메서드는 거의 모든 객체를(Serializable 인터페이스가 구현된) 만들어 낼 수 있다.  
바이트 스트림을 역직렬화하는 과정에서 이 메서드는 그 타입들 안의 모든 코드를 수행할 수 있다.  
이 말인 즉슨, 그 타입들의 코드 전체가 공격 범위에 들어간다는 뜻  

</br>

### 가젯(gadget)
자바 라이브러리와 널리 쓰이는 서드파티 라이브러리에서 역직렬화 과정에서 호출되어 잠재적으로 위험한 동작을 수행하는 메서드  
여러 가젯을 함께 사용하여 가젯 체인을 구성 가능  
가끔씩 공격자가 기반 하드웨어의 네이티브 코드를 마음대로 실행할 수 있는 강력한 가젯 체인도 발견  

</br>

### 역직렬화 폭탄(deserialization bomb)
역직렬화에 시간이 오래 걸리는 짧은 스트림  
역직렬화 폭탄을 역직렬화하는 것만으로 서비스 거부 공격에 쉽게 노출  

</br>

### 바우터르 쿠카르츠(Wouter Coekaerts)의 HashSet 역직렬화 폭탄
```` java
static byte[] bomb() {
  Set<Object> root = new HashSet<>();
  Set<Object> s1 = root;
  Set<Object> s2 = new HashSet<>();
  for (int i = 0; i < 100; i++) {
    Set<Object> t1 = new HashSet<>();
    Set<Object> t2 = new HashSet<>();
    t1.add("foo");
    s1.add(t1);
    s1.add(t2);
    s2.add(t1);
    s2.add(t2);
    s1 = t1;
    s2 = t2;
  }
  return serialize(root);
}
````

이 객체 그래프는 201개의 HashSet 인스턴스로 구성  
그 각각은 3개 이하의 객체 참조 보유  
스트림 전체 크기 5,744 바이트  
HashSet 인스턴스를 역직렬화하기 위해 그 원소들의 해시코드 계산 필수  
따라서 이 HashSet을 역직렬화하려면 hashCode 메서드를 2^100번 이상 호출  

</br>

### 직렬화 공격 대처
직렬화 위험을 회피하는 가장 좋은 방법은 아무것도 역직렬화하지 않는 것  
자바 직렬화가 아닌 객체와 바이트 시퀀스를 변환해주는 여러가지 매커니즘 존재  
레거시 시스템 때문에 자바 직렬화를 배제할 수 없을 경우 신뢰할 수 없는 데이터는 절대 역직렬화 금지  
객체 역직렬화 필터링(java.io.ObjectInputFilter)를 사용  

</br>

### 크로스-플랫폼 구조화된 데이터 표현(cross-platform structued-data representation)
자바 직렬화보다 훨씬 간단하다.  
임의 객체 그래프를 자동으로 직렬화/역직렬화하지 않는다.  
대신 속성-값 쌍의 집합으로 구성된 간단하고 구조화된 데이터 객체를 사용한다.  
대표적으로 JSON과 프로토콜 버퍼(protobuf)가 존재한다.  

</br>

### 객체 역직렬화 필터링
데이터 스트림이 역직렬화되기 전에 필터를 설치하는 기능  
클래스 단위로, 특정 클래스를 받아들이거나 거부 가능  
'기본 수용' 모드에서는 블랙리스트에 기록된 잠재적 위험 클래스를 거부  
반대로 '기본 거부' 모드에서는 화이트리스트에 기록된 안전 클래스만 허용  
기본 수용 모드보단 기본 거부 모드 권장  

</br>



